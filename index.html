<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Thêm viewport để tối ưu hóa di động -->
    <title>越南语听力练习</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            margin: 0; 
            padding-bottom: 300px; /* Mặc định cho màn hình lớn */
            background-color: #f7fbf3;
        }
        #gameContainer {
            display: block;
            min-height: calc(100vh - 150px); /* Đảm bảo nội dung chiếm đủ chiều cao màn hình */
        }
        #infoBox { 
            width: 95%; 
            max-width: 700px;
            min-height: 100px; 
            margin: 0 auto; 
            border: 1px solid #ccc; 
            background: #68838B; 
            color: #D2B48C; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 60px);
            font-weight: bold;
        }
        #contactBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 1px solid #ccc; 
            background: #68838B; 
            color: #D2B48C; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #instructionBox { 
            width: 90%; 
            max-width: 700px;
            min-height: 25px; 
            margin: 0px auto; 
            border: 1px solid #ccc; 
            background: #68838B; 
            color: #D2B48C; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(16px, 2vw, 20px); 
            font-weight: bold;
        }
        #controls { 
            position: fixed; /* Cố định ở cuối màn hình */
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 800px; /* Giới hạn chiều rộng tối đa */
            background: #68838B; 
            padding: 10px 0; 
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); 
            z-index: 1000; 
        }
        #controls div {
            margin: 5px 0; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        button { 
            padding: 8px 8px; 
            margin: 0 5px; 
            cursor: pointer; 
            border: 3px solid #5d757d; 
            background: #0f1314; 
            color: #fffbef; 
            font-size: 28px; 
            border-radius: 5px; 
        }
        #sentenceNumber { 
            width: 50px; 
            padding: 10px; 
            text-align: center; 
            border: 3px solid #68838B; 
            background: #FFAD5B; 
            color: #000; 
            border-radius: 10px; 
            font-size: 16px; 
            -moz-appearance: textfield; 
        }
        #sentenceNumber::-webkit-inner-spin-button, 
        #sentenceNumber::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        #sentenceNumber:disabled { 
            background: #eee; 
        }
        .disabled { 
            cursor: not-allowed; 
            pointer-events: none; 
        }
        .active-mode { 
            border: 4px solid orange; 
        }
        #indicator { 
            width: 95%;
                        max-width: 700px; 
            min-height: 50px; 
            margin: 10px auto; 
                        padding: 5px;
            border: 3px solid #734A2E; 
            background: #ffffe0; 
            border-radius: 10px; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        #optionsContainer {
            width: 100%;
            max-width: 700px;
            margin: 10px auto;
        }
        .optionBtn {
            width: 95%; 
            max-width: 700px;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #734A2E;
            background: #ffffff; /*E6EDD9*/
            color: #000;
            font-size: 30px;
            text-align: left;
            cursor: pointer;
            border-radius: 5px;
        }
        .optionBtn:hover {
            background: #D2E4C4;
        }
        .correct {
            background: #B7D7AA !important;
        }
        .wrong {
            background: #CE6D5E !important;
        }
        #score { 
            display: none; 
            width: 100%;
            max-width: 700px;
            margin: 10px auto; 
            color: #FF6820; 
            font-size: 30px; 
            text-align: center;
        }
        #wrongSentences { 
            display: none; 
            width: 95%; 
            max-width: 700px; 
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #CE6D5E; 
            background: #FFF0F0; 
            color: #CE6D5E; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
        }
        #results { 
            display: none; 
            width: 95%;
            max-width: 700px;        
            margin: 10px auto; 
            padding: 10px; 
            border: 2px solid #734A2E; 
            background: #fffbef; 
            color: #000; 
            font-size: 30px; 
            text-align: left; 
            border-radius: 5px; 
            white-space: pre-line;
        }

        /* Media query cho thiết bị di động */
        @media (max-width: 768px) {
            body {
                padding-bottom: 200px; /* Giảm padding-bottom cho điện thoại */
            }
            #controls {
                padding: 5px 0; /* Giảm padding */
            }
            button {
                padding: 6px 6px; /* Giảm kích thước nút */
                font-size: 20px; /* Giảm kích thước chữ */
            }
            #sentenceNumber {
                width: 40px; /* Giảm chiều rộng */
                padding: 8px; /* Giảm padding */
                font-size: 14px; /* Giảm kích thước chữ */
            }
            .optionBtn {
                font-size: 20px; /* Giảm kích thước chữ cho đáp án */
                padding: 8px; /* Giảm padding */
            }
            #infoBox {
                font-size: clamp(30px, 4vw, 40px); /* Giảm kích thước chữ */
            }
            #contactBox, #instructionBox {
                font-size: clamp(14px, 2vw, 16px); /* Giảm kích thước chữ */
            }
            #indicator {
                min-height: 40px; /* Giảm chiều cao tối thiểu */
            }
            #results, #wrongSentences, #score {
                font-size: 24px; /* Giảm kích thước chữ */
                                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="infoBox">习得越南语<br>听力练习</div>
        <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
        <div id="instructionBox">选择与播放内容相符的选项</div>
        <div id="indicator"></div>
        <div id="optionsContainer"></div>
        <div id="results"></div>
        <div id="score">0/0</div>
        <div id="wrongSentences"></div>
    </div>
    <div id="controls">
        <div>
            <button id="freeModeBtn" class="active-mode">自由模式</button>
            <button id="testModeBtn">作业模式</button>
        </div>
        <div>
            <button id="autoContinueBtn">自动继续</button>
            <button id="showHideBtn">显示-隐藏</button>
        </div>
        <div>
            <button id="prevBtn">◀</button>
            <input type="text" id="sentenceNumber" inputmode="numeric" pattern="[0-9]*">
            <button id="nextBtn">▶</button>
            <button id="replayBtn">再听一遍</button>
        </div>
    </div>
    <audio id="mainAudio" src="audio.mp3"></audio>
    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <script>
        const audio = document.getElementById('mainAudio');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');
        const indicator = document.getElementById('indicator');
        const sentenceNumber = document.getElementById('sentenceNumber');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const replayBtn = document.getElementById('replayBtn');
        const freeModeBtn = document.getElementById('freeModeBtn');
        const testModeBtn = document.getElementById('testModeBtn');
        const autoContinueBtn = document.getElementById('autoContinueBtn');
        const showHideBtn = document.getElementById('showHideBtn');
        const scoreDisplay = document.getElementById('score');
        const wrongSentencesDisplay = document.getElementById('wrongSentences');
        const optionsContainer = document.getElementById('optionsContainer');
        const resultsDisplay = document.getElementById('results');

        const buttons = [prevBtn, nextBtn, replayBtn, freeModeBtn, testModeBtn, autoContinueBtn, showHideBtn];

const sentences = [
    {
        "audioFile": "audio.mp3",
        "start": 0.549583,
        "end": 1.939583,
        "correctAnswer": "Mời anh vào nhà.",
        "translation": "请你进屋。",
        "options": [
            "Mời anh vào nhạ.",
            "Mời ảnh vào nhà.",
            "Mơi anh vào nhà.",
            "Mời anh vào nhà."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 2.859583,
        "end": 4.329583,
        "correctAnswer": "Mời chị vào nhà.",
        "translation": "请你进屋（对女性说）。",
        "options": [
            "Mời chị vào nhá.",
            "Mời chi vào nhà.",
            "Mời chị vào nhà.",
            "Mời chị vào nà."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 5.199583,
        "end": 6.169583,
        "correctAnswer": "Mời vào.",
        "translation": "请进。",
        "options": [
            "Mòi vào.",
            "Mời vào.",
            "Mời vảo.",
            "Mời vao."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 7.219583,
        "end": 8.419583,
        "correctAnswer": "Mời ông ngồi.",
        "translation": "请您坐（对年长男性说）。",
        "options": [
            "Mời ông ngồi.",
            "Mời ông ngòi.",
            "Mời ông ngồii.",
            "Mời ông gồi."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 9.389583,
        "end": 10.709583,
        "correctAnswer": "Mời bà ngồi.",
        "translation": "请您坐（对年长女性说）。",
        "options": [
            "Mời bà ngồi.",
            "Mời bá ngồi.",
            "Mời bà ngòi.",
            "Mời bà gồi."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 11.739583,
        "end": 12.709583,
        "correctAnswer": "Mời ngồi.",
        "translation": "请坐。",
        "options": [
            "Mời ngồi.",
            "Mời ngòi.",
            "Mời gồi.",
            "Mơi ngồi."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 13.739583,
        "end": 15.089583,
        "correctAnswer": "Mời anh uống nước.",
        "translation": "请你喝水。",
        "options": [
            "Mời anh uống nướt.",
            "Mời anh uống nước.",
            "Mời anh uổng nước.",
            "Mời ảnh uống nước."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 16.229583,
        "end": 17.599583,
        "correctAnswer": "Mời chị uống nước.",
        "translation": "请你喝水（对女性说）。",
        "options": [
            "Mời chị uống nước.",
            "Mời chị uống nược.",
            "Mời chi uống nước.",
            "Mời chị uống nướt."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 18.689583,
        "end": 20.169583,
        "correctAnswer": "Xin anh cứ tự nhiên.",
        "translation": "请你随意（男）。",
        "options": [
            "Xin anh cứ tự nhiên.",
            "Xin anh cứ tụ nhiên.",
            "Xin ảnh cứ tự nhiên.",
            "Xin anh cừ tự nhiên."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 21.219583,
        "end": 22.559583,
        "correctAnswer": "Anh cứ tự nhiên.",
        "translation": "你随意吧（男）。",
        "options": [
            "Anh cứ tự nhiên.",
            "Anh cừ tự nhiên.",
            "Ảnh cứ tự nhiên.",
            "Anh cứ tụ nhiên."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 23.599583,
        "end": 24.799583,
        "correctAnswer": "Xin chị cứ tự nhiên.",
        "translation": "请你随意（女）。",
        "options": [
            "Xin chị cứ tự nhiên.",
            "Xin chị cứ tụ nhiên.",
            "Xin chi cứ tự nhiên.",
            "Xin chị cừ tự nhiên."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 25.749583,
        "end": 26.989583,
        "correctAnswer": "Chị cứ tự nhiên.",
        "translation": "你随意吧（女）。",
        "options": [
            "Chị cứ tự nhiên.",
            "Chị cừ tự nhiên.",
            "Chi cứ tự nhiên.",
            "Chị cứ tụ nhiên."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 28.009583,
        "end": 29.229583,
        "correctAnswer": "Xin cứ tự nhiên.",
        "translation": "请随意。",
        "options": [
            "Xin cứ tự nhiên.",
            "Xin cứ tụ nhiên.",
            "Xin cừ tự nhiên.",
            "Xin cứ tự nhiênn."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 30.259583,
        "end": 31.559583,
        "correctAnswer": "Mời anh hút thuốc.",
        "translation": "请你抽烟。",
        "options": [
            "Mời anh hút thuốc.",
            "Mời anh hút thuộc.",
            "Mời anh húc thuốc.",
            "Mời ảnh hút thuốc."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 32.159583,
        "end": 35.059583,
        "correctAnswer": "Mời ông bà anh chị và mọi người ăn cơm.",
        "translation": "请各位长辈、兄姐和大家吃饭。",
        "options": [
            "Mời ông bà anh chị và mọi người ăn cơm.",
            "Mời ông bà anh chị và mọi người ẳn cơm.",
            "Mời ông bà anh chị và mọi người ăn cơn.",
            "Mời ông bà anh chỉ và mọi người ăn cơm."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 35.639583,
        "end": 37.139583,
        "correctAnswer": "Mời mọi người ăn cơm.",
        "translation": "请大家吃饭。",
        "options": [
            "Mời mọi người ăn cơm.",
            "Mời mọi ngươi ăn cơm.",
            "Mời mọi người ẳn cơm.",
            "Mời mọi người ăn cơn."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 37.709583,
        "end": 40.479583,
        "correctAnswer": "Mời ông bà anh chị và mọi người xơi cơm.",
        "translation": "请各位长辈、兄姐和大家开饭。",
        "options": [
            "Mời ông bà anh chị và mọi người xơi cơm.",
            "Mời ông bà anh chỉ và mọi người xơi cơm.",
            "Mời ông bà anh chị và mọi người xơi cớm.",
            "Mời ông bà anh chị và mọi người sơi cơm."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 41.079583,
        "end": 42.589583,
        "correctAnswer": "Mời mọi người xơi cơm.",
        "translation": "请大家用饭。",
        "options": [
            "Mời mọi người xơi cơm.",
            "Mời mọi người sơi cơm.",
            "Mời mọi người xơi cớm.",
            "Mời mọi ngươi xơi cơm."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 43.449583,
        "end": 45.019583,
        "correctAnswer": "Mời cả nhà ăn cơm.",
        "translation": "请全家吃饭。",
        "options": [
            "Mời cả nhạ ăn cơm.",
            "Mời cả nhà ăn cơm.",
            "Mời cả nhà ẳn cơm.",
            "Mời cả nhà ăn cơn."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 46.709583,
        "end": 49.049583,
        "correctAnswer": "Xin phép cả nhà, cháu ăn xong rồi.",
        "translation": "请全家允许，我吃完了。",
        "options": [
            "Xin phép cả nhà, cháu ăn xong rồi.",
            "Xin phép cả nhà, cháu ẳn xong rồi.",
            "Xin phép cả nhà, cháu ăn son rồi.",
            "Xin phép cả nhà, chấu ăn xong rồi."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 50.199583,
        "end": 52.399583,
        "correctAnswer": "Mọi người ăn đi, mình ăn xong rồi.",
        "translation": "大家请吃吧，我吃完了。",
        "options": [
            "Mọi người ăn đi, mình ăn xong rồi.",
            "Mọi người ăn đi, minh ăn xong rồi.",
            "Mọi người ăn đi, mình ăn son rồi.",
            "Mọi ngươi ăn đi, mình ăn xong rồi."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 53.439583,
        "end": 54.989583,
        "correctAnswer": "Anh ăn thêm chút nữa.",
        "translation": "你再吃一点吧（男）。",
        "options": [
            "Anh ăn thêm chút nữa.",
            "Anh ăn thêm chuốt nữa.",
            "Ảnh ăn thêm chút nữa.",
            "Anh ăn thêm chúc nữa."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 55.969583,
        "end": 57.589583,
        "correctAnswer": "Chị ăn thêm chút nữa nhé.",
        "translation": "你再吃一点吧（女）。",
        "options": [
            "Chị ăn thêm chút nữa nhé.",
            "Chị ăn thèm chút nữa nhé.",
            "Chi ăn thêm chút nữa nhé.",
            "Chị ăn thêm chút nứa nhé."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 58.799583,
        "end": 60.619583,
        "correctAnswer": "Cám ơn. Tôi no rồi.",
        "translation": "谢谢。我吃饱了。",
        "options": [
            "Cám ơn. Tôi no rồi.",
            "Cám ơn. Tôi nô rồi.",
            "Cám ơn. Tối no rồi.",
            "Cám ơn. Tôi no rổi."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 61.979583,
        "end": 64.189583,
        "correctAnswer": "Cám ơn chị. Tôi ăn đủ rồi.",
        "translation": "谢谢你，我吃够了（对女性说）。",
        "options": [
            "Cám ơn chị. Tôi ăn đủ rồi.",
            "Cám ơn chị. Tôi ăn rủ rồi.",
            "Cám ơn chi. Tôi ăn đủ rồi.",
            "Cám ơn chị. Tôi ăn dũ rồi."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 65.059583,
        "end": 66.679583,
        "correctAnswer": "Cái bàn làm bằng gỗ.",
        "translation": "这张桌子是木头做的。",
        "options": [
            "Cái bàn làm bằng gỗ.",
            "Cái bàn làm bằng cố.",
            "Cái bàng làm bằng gỗ.",
            "Cái bàn làm băng gỗ."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 67.889583,
        "end": 69.529583,
        "correctAnswer": "Bức tường xây bằng gạch.",
        "translation": "墙是用砖建的。",
        "options": [
            "Bức tường xây bằng gạch.",
            "Bức tường xây bằng gãch.",
            "Bức tường xây băng gạch.",
            "Bức tưởng xây bằng gạch."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 71.069583,
        "end": 72.699583,
        "correctAnswer": "Chiếc cối làm bằng đá.",
        "translation": "这只石臼是用石头做的。",
        "options": [
            "Chiếc cối làm bằng đá.",
            "Chiếc cối làm bằng đà.",
            "Chiếc cối lam bằng đá.",
            "Chiếc cối làm bàng đá."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 73.919583,
        "end": 75.729583,
        "correctAnswer": "Họ trao đổi bằng tiếng Việt.",
        "translation": "他们用越南语交流。",
        "options": [
            "Họ trao đổi bằng tiếng Việt.",
            "Họ trao đỗi bằng tiếng Việt.",
            "Họ trao đổi bằng tiếng Việc.",
            "Họ trao đổi băng tiếng Việt."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 76.709583,
        "end": 78.209583,
        "correctAnswer": "Họ ăn bằng đũa.",
        "translation": "他们用筷子吃饭。",
        "options": [
            "Họ ăn bằng đũa.",
            "Họ ăn bằng đuã.",
            "Họ ăn bàng đũa.",
            "Họ ăn bằng đũã."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 79.649583,
        "end": 81.379583,
        "correctAnswer": "Mình đến trường bằng xe đạp.",
        "translation": "我骑自行车去学校。",
        "options": [
            "Mình đến trường bằng xe đạp.",
            "Mình đến trưởng bằng xe đạp.",
            "Mình đến trường bằng xe đạp̣.",
            "Mình đến trường băng xe đạp."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 85.219583,
        "end": 87.909583,
        "correctAnswer": "Tôi sẽ ở Việt Nam thêm ba tháng nữa.",
        "translation": "我将在越南再待三个月。",
        "options": [
            "Tôi sẽ ở Việt Nam thêm ba tháng nữa.",
            "Tôi sẽ ở Việt Nam thêm ba tháng nứa.",
            "Tôi sẽ ở Việt Nam thêm ba tháng nữaa.",
            "Tôi sẽ ỡ Việt Nam thêm ba tháng nữa."
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 90.519583,
        "end": 92.609583,
        "correctAnswer": "Chị mua thêm chiếc áo này nhé!",
        "translation": "你再买这件衣服吧！（对女性说）",
        "options": [
            "Chị mua thêm chiếc áo này nhé!",
            "Chị mua thèm chiếc áo này nhé!",
            "Chị mua thêm chiệc áo này nhé!",
            "Chi mua thêm chiếc áo này nhé!"
        ]
    },
    {
        "audioFile": "audio.mp3",
        "start": 94.389583,
        "end": 96.269583,
        "correctAnswer": "Chị ăn thêm một bát nữa nhé!",
        "translation": "你再吃一碗吧！（对女性说）",
        "options": [
            "Chị ăn thêm một bát nữa nhé!",
            "Chị ăn thêm một bát nứa nhé!",
            "Chi ăn thêm một bát nữa nhé!",
            "Chị ăn thêm một bắt nữa nhé!"
        ]
    }
];

        let currentIndex = 0;
        let isFreeMode = true;
        let correctCount = 0;
        let isPlaying = false;
        let correctSentences = new Set();
        let wrongSentences = new Set();
        let autoContinue = false;
        let showAnswer = false;
        let userAnswers = [];

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function init() {
            updateSentenceDisplay();
        }

        function updateSentenceDisplay() {
            sentenceNumber.value = currentIndex + 1;
            indicator.style.background = '#ffffe0';
            if (isFreeMode && showAnswer) {
                indicator.innerHTML = `
                    <div style="font-size: 20px; font-weight: normal; color: #38761d;">${sentences[currentIndex].translation}</div>
                `;
            } else {
                indicator.innerHTML = '';
            }
            updateOptions();
            if (!isFreeMode) updateScore();
        }

        function updateOptions() {
            optionsContainer.innerHTML = '';
            const shuffledOptions = shuffleArray(sentences[currentIndex].options);
            shuffledOptions.forEach((option, index) => {
                const btn = document.createElement('button');
                btn.className = 'optionBtn';
                btn.textContent = option;
                btn.onclick = () => checkAnswer(option);
                optionsContainer.appendChild(btn);
            });
        }

        function playCurrentSentence() {
            if (isPlaying) audio.pause();
            buttons.forEach(btn => btn.classList.add('disabled'));
            sentenceNumber.disabled = true;
            isPlaying = true;
            audio.src = sentences[currentIndex].audioFile;
            audio.currentTime = sentences[currentIndex].start;
            audio.play().catch(error => {
                console.error('Audio playback failed:', error);
                alert('Vui lòng nhấn nút “再听一遍” để phát âm thanh.');
                buttons.forEach(btn => btn.classList.remove('disabled'));
                sentenceNumber.disabled = false;
                isPlaying = false;
            });

            audio.ontimeupdate = () => {
                if (audio.currentTime >= sentences[currentIndex].end) {
                    audio.pause();
                    audio.ontimeupdate = null;
                    buttons.forEach(btn => btn.classList.remove('disabled'));
                    sentenceNumber.disabled = false;
                    isPlaying = false;
                }
            };
        }

        function moveSentence(direction) {
            currentIndex = (currentIndex + direction + sentences.length) % sentences.length;
            updateSentenceDisplay();
            playCurrentSentence();
        }

        function checkAnswer(selectedAnswer) {
            const correctAnswer = sentences[currentIndex].correctAnswer;
            const optionButtons = optionsContainer.getElementsByClassName('optionBtn');
            
            // Clear previous styles
            for (let btn of optionButtons) {
                btn.classList.remove('correct', 'wrong');
                btn.disabled = !isFreeMode; // Only disable buttons in Test Mode
            }

            // Find and style the selected button
            for (let btn of optionButtons) {
                if (btn.textContent === selectedAnswer) {
                    if (selectedAnswer === correctAnswer) {
                        indicator.style.background = '#B7D7AA';
                        btn.classList.add('correct');
                        correctAudio.play().catch(error => {
                            console.error('Correct audio playback failed:', error);
                        });
                    } else {
                        indicator.style.background = '#CE6D5E';
                        btn.classList.add('wrong');
                        wrongAudio.play().catch(error => {
                            console.error('Wrong audio playback failed:', error);
                        });
                    }
                }
            }

            if (!isFreeMode) {
                userAnswers[currentIndex] = selectedAnswer;
                if (selectedAnswer === correctAnswer && !correctSentences.has(currentIndex)) {
                    correctCount++;
                    correctSentences.add(currentIndex);
                    wrongSentences.delete(currentIndex);
                } else if (selectedAnswer !== correctAnswer && !correctSentences.has(currentIndex)) {
                    wrongSentences.add(currentIndex);
                }
                updateScore();

                // Auto-move to next sentence in Test Mode
                const audioToWait = (selectedAnswer === correctAnswer) ? correctAudio : wrongAudio;
                audioToWait.onended = () => {
                    if (userAnswers.length === sentences.length) {
                        showResults();
                    } else {
                        setTimeout(() => {
                            moveSentence(1);
                        }, 200);
                    }
                };
            } else if (isFreeMode && autoContinue && selectedAnswer === correctAnswer) {
                // Auto-move in Free Mode only if answer is correct and autoContinue is enabled
                correctAudio.onended = () => {
                    setTimeout(() => {
                        moveSentence(1);
                    }, 200);
                };
            } else {
                correctAudio.onended = null;
                wrongAudio.onended = null;
            }
        }

        function updateScore() {
            scoreDisplay.textContent = `${correctCount}/${sentences.length}`;
            scoreDisplay.style.display = 'block'; // Hiển thị score trong Test Mode
        }

        function showResults() {
            let resultText = `练习完成！\n正确答案数量：${correctCount}/${sentences.length}\n正确率：${((correctCount / sentences.length) * 100).toFixed(2)}%\n错误题目：`;
            wrongSentences.forEach(index => {
                resultText += `\n第${index + 1}题：\n你的选择：${userAnswers[index] || '未选择'}\n正确答案：${sentences[index].correctAnswer}\n`;
            });
            if (wrongSentences.size === 0) {
                resultText += '\n全部正确！';
            }
            resultsDisplay.textContent = resultText;
            resultsDisplay.style.display = 'block';
        }

        prevBtn.onclick = () => {
            moveSentence(-1);
        };

        nextBtn.onclick = () => {
            moveSentence(1);
        };

        replayBtn.onclick = () => {
            playCurrentSentence();
        };

        freeModeBtn.onclick = () => {
            isFreeMode = true;
            freeModeBtn.classList.add('active-mode');
            testModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = false;
            autoContinueBtn.classList.remove('disabled');
            showHideBtn.disabled = false;
            showHideBtn.classList.remove('disabled');
            scoreDisplay.style.display = 'none';
            wrongSentencesDisplay.style.display = 'none';
            resultsDisplay.style.display = 'none';
            updateSentenceDisplay();
        };

        testModeBtn.onclick = () => {
            isFreeMode = false;
            testModeBtn.classList.add('active-mode');
            freeModeBtn.classList.remove('active-mode');
            autoContinueBtn.disabled = true;
            autoContinueBtn.classList.add('disabled');
            showHideBtn.disabled = true;
            showHideBtn.classList.add('disabled');
            showHideBtn.classList.remove('active-mode');
            showAnswer = false;
            scoreDisplay.style.display = 'block';
            currentIndex = 0;
            correctCount = 0;
            correctSentences.clear();
            wrongSentences.clear();
            userAnswers = [];
            for (let i = 0; i < sentences.length; i++) {
                wrongSentences.add(i);
            }
            updateSentenceDisplay();
        };

        autoContinueBtn.onclick = () => {
            if (isFreeMode) {
                autoContinue = !autoContinue;
                autoContinueBtn.classList.toggle('active-mode');
                if (!autoContinue) {
                    correctAudio.onended = null;
                }
            }
        };

        showHideBtn.onclick = () => {
            if (isFreeMode) {
                showAnswer = !showAnswer;
                showHideBtn.classList.toggle('active-mode');
                updateSentenceDisplay();
            }
        };

        sentenceNumber.onchange = () => {
            if (!isPlaying) {
                const num = parseInt(sentenceNumber.value) - 1;
                if (!isNaN(num) && num >= 0 && num < sentences.length) {
                    currentIndex = num;
                    updateSentenceDisplay();
                    playCurrentSentence();
                } else {
                    alert(`输入范围： 1 到 ${sentences.length}`);
                    updateSentenceDisplay();
                }
            }
        };

        sentenceNumber.onkeydown = (e) => {
            if (!isPlaying) {
                if (e.key === 'ArrowLeft') {
                    moveSentence(-1);
                }
                if (e.key === 'ArrowRight') {
                    moveSentence(1);
                }
            }
        };

        init();
    </script>
</body>
</html>